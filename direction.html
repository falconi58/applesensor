<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>平滑行走模拟器 (已配置IP)</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background-color: #111;
            color: #0f0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }
        #canvas-area {
            width: 300px;
            height: 300px;
            border: 2px solid #0f0;
            position: relative;
            background: 
                linear-gradient(rgba(0,255,0,0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0,255,0,0.1) 1px, transparent 1px);
            background-size: 30px 30px;
        }
        #pointer {
            width: 14px;
            height: 14px;
            background-color: red;
            border-radius: 50%;
            position: absolute;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 10px red;
            transition: left 0.05s linear, top 0.05s linear;
        }
        #info { margin-top: 20px; text-align: center; width: 90%; }
        button { padding: 15px 30px; font-size: 18px; margin-bottom: 20px; background: #0f0; border: none; font-weight: bold; cursor: pointer; }
        .log { font-size: 12px; color: gray; margin-top: 5px; word-break: break-all; }
        
        /* 状态指示灯 */
        .status-dot {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: gray;
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <button id="btn" onclick="requestPermission()">点击授权并开始</button>

    <div id="canvas-area">
        <div id="pointer" style="left: 50%; top: 50%;"></div>
    </div>

    <div id="info">
        <div><span id="status-dot" class="status-dot"></span>状态: <span id="status-text">未连接</span></div>
        <hr style="border-color: #333; margin: 10px 0;">
        <div>X: <span id="val-x">250.0</span> | Y: <span id="val-y">250.0</span></div>
        <div>速度: <span id="speed">0</span> m/s</div>
        <div class="log" id="net-log">等待连接服务器...</div>
    </div>

    <script>
        // ==========================================
        // ▼▼▼ 已帮你填好 ▼▼▼
        const IP = "192.168.1.33"; 
        const PORT = "5000"; // Flask 默认端口
        const SERVER_URL = `http://${IP}:${PORT}/data`;
        // ==========================================
        
        const MAX_SPEED = 3.0; 
        const FPS = 50;        
        const SEND_RATE = 200; // 0.2秒发一次，更跟手
        
        let posX = 250.0;
        let posY = 250.0;
        let tiltX = 0; 
        let tiltY = 0; 
        
        // --- 1. 物理引擎 ---
        setInterval(() => {
            let vx = tiltX * MAX_SPEED;
            let vy = tiltY * MAX_SPEED;

            posX += vx / (FPS / 10); 
            posY += vy / (FPS / 10);

            if(posX < 0) posX = 0;
            if(posX > 500) posX = 500;
            if(posY < 0) posY = 0;
            if(posY > 500) posY = 500;

            document.getElementById('pointer').style.left = (posX / 500 * 100) + '%';
            document.getElementById('pointer').style.top = (posY / 500 * 100) + '%';
            document.getElementById('val-x').innerText = posX.toFixed(1);
            document.getElementById('val-y').innerText = posY.toFixed(1);
            
            let currentSpeed = Math.sqrt(vx*vx + vy*vy);
            document.getElementById('speed').innerText = currentSpeed.toFixed(1);
        }, 1000 / FPS);

        // --- 2. 传感器 ---
        function handleOrientation(event) {
            let g = event.gamma || 0;
            let b = event.beta || 0;
            // 调整灵敏度，除数越小越灵敏
            tiltX = clamp(g / 20, -1, 1);
            tiltY = clamp(b / 20, -1, 1);
            tiltY = -tiltY; 
        }

        // --- 3. 网络发送 ---
        setInterval(() => {
            const payload = {
                x: Math.round(posX),
                y: Math.round(posY)
            };

            const logEl = document.getElementById('net-log');
            const statusDot = document.getElementById('status-dot');
            const statusText = document.getElementById('status-text');

            fetch(SERVER_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
                keepalive: true 
            })
            .then(response => {
                if (response.ok) return response.json();
                throw new Error("Server Error");
            })
            .then(data => {
                statusDot.style.backgroundColor = "#0f0"; // 绿灯
                statusText.innerText = "在线";
                statusText.style.color = "#0f0";
                logEl.innerText = `发送: (${payload.x}, ${payload.y}) -> 成功`;
                logEl.style.color = "gray";
            })
            .catch(error => {
                statusDot.style.backgroundColor = "red"; // 红灯
                statusText.innerText = "连接失败";
                statusText.style.color = "red";
                // 显示更具体的错误建议
                logEl.innerText = `无法连接 ${IP}:${PORT}\n请检查电脑防火墙!`;
                logEl.style.color = "red";
            });

        }, SEND_RATE);

        function clamp(val, min, max) { return Math.min(Math.max(val, min), max); }
        
        function requestPermission() {
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission().then(state => {
                    if (state === 'granted') {
                        window.addEventListener('deviceorientation', handleOrientation);
                        document.getElementById('btn').style.display = 'none';
                    } else {
                        alert("需要传感器权限才能控制哦");
                    }
                });
            } else {
                window.addEventListener('deviceorientation', handleOrientation);
                document.getElementById('btn').style.display = 'none';
            }
        }
    </script>
</body>
</html>
