<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>1Hz 低频采样坐标系</title>
    <style>
        body {
            font-family: 'Courier New', Courier, monospace; /* 像代码一样的字体 */
            text-align: center;
            background-color: #222;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        /* 坐标系容器 */
        #canvas-area {
            width: 320px;
            height: 320px;
            background-color: #1a1a1a;
            border: 2px solid #00ff00; /* 绿色黑客风格边框 */
            position: relative;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.2);
            /* 网格背景 */
            background-image: 
                linear-gradient(rgba(0, 255, 0, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 0, 0.1) 1px, transparent 1px);
            background-size: 32px 32px; /* 模拟 500x500 的网格比例 */
        }

        /* 坐标轴线 */
        .axis-x {
            position: absolute;
            top: 50%;
            left: 0;
            width: 100%;
            height: 1px;
            background-color: #00ff00;
            opacity: 0.5;
        }
        .axis-y {
            position: absolute;
            left: 50%;
            top: 0;
            height: 100%;
            width: 1px;
            background-color: #00ff00;
            opacity: 0.5;
        }

        /* 坐标标记文字 */
        .label {
            position: absolute;
            font-size: 10px;
            color: #00ff00;
        }
        .tl { top: 2px; left: 2px; } /* 左上 0,0 */
        .tr { top: 2px; right: 2px; } /* 右上 500,0 */
        .bl { bottom: 2px; left: 2px; } /* 左下 0,500 */
        .br { bottom: 2px; right: 2px; } /* 右下 500,500 */
        .center-lbl { top: 51%; left: 51%; opacity: 0.7; }

        /* 红点 (现在不需要丝滑过渡，因为是1秒1跳) */
        #pointer {
            width: 16px;
            height: 16px;
            background-color: red;
            border: 2px solid white;
            border-radius: 50%;
            position: absolute;
            transform: translate(-50%, -50%);
            top: 50%;
            left: 50%;
            box-shadow: 0 0 10px red;
            z-index: 10;
        }

        #data-panel {
            margin-top: 20px;
            padding: 15px;
            background: #333;
            border-radius: 8px;
            width: 300px;
            border: 1px solid #555;
        }
        
        .row { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .highlight { color: #00ff00; font-weight: bold; font-size: 1.2em; }
        
        button {
            margin-bottom: 15px;
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
        }

        /* 闪烁指示灯，表示正在采样 */
        #status-led {
            width: 10px;
            height: 10px;
            background-color: gray;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        .blink { animation: blinker 0.2s linear; }
        @keyframes blinker { 50% { background-color: #00ff00; box-shadow: 0 0 10px #00ff00; } }
    </style>
</head>
<body>

    <button id="permission-btn" style="display:none;">点击授权传感器</button>

    <h3>后端同步视窗 (1Hz)</h3>
    <div style="font-size: 12px; color: #aaa; margin-bottom: 10px;">
        <span id="status-led"></span> 状态: <span id="status-text">等待数据...</span>
    </div>

    <div id="canvas-area">
        <div class="axis-x"></div>
        <div class="axis-y"></div>
        <div class="label tl">0,0</div>
        <div class="label tr">500,0</div>
        <div class="label bl">0,500</div>
        <div class="label br">500,500</div>
        <div class="label center-lbl">250,250</div>
        
        <div id="pointer"></div>
    </div>

    <div id="data-panel">
        <div class="row">
            <span>X 坐标:</span>
            <span id="val-x" class="highlight">250</span>
        </div>
        <div class="row">
            <span>Y 坐标:</span>
            <span id="val-y" class="highlight">250</span>
        </div>
        <hr style="border-color: #444;">
        <div class="row" style="font-size: 12px; color: #aaa;">
            <span>原始 Gamma:</span><span id="raw-g">0</span>
        </div>
        <div class="row" style="font-size: 12px; color: #aaa;">
            <span>原始 Beta:</span><span id="raw-b">0</span>
        </div>
    </div>

    <script>
        // 配置区域
        const UPDATE_INTERVAL = 1000; // 1000毫秒 = 1秒
        const MAX_TILT = 30;          // 倾斜灵敏度
        const INVERT_Y = true;        // true: 抬头=向上(Y变小) | false: 抬头=向下(Y变大)
        
        // 变量缓存
        let currentGamma = 0;
        let currentBeta = 0;
        let timer = null;

        // DOM 元素
        const ball = document.getElementById('pointer');
        const valX = document.getElementById('val-x');
        const valY = document.getElementById('val-y');
        const rawG = document.getElementById('raw-g');
        const rawB = document.getElementById('raw-b');
        const led = document.getElementById('status-led');
        const statusText = document.getElementById('status-text');

        // 辅助函数：映射
        function mapRange(value, inMin, inMax, outMin, outMax) {
            return (value - inMin) * (outMax - outMin) / (inMax - inMin) + outMin;
        }
        function clamp(val, min, max) {
            return Math.min(Math.max(val, min), max);
        }

        // 1. 传感器监听 (高频，仅负责存数据)
        function handleOrientation(event) {
            if(event.gamma !== null) currentGamma = event.gamma;
            if(event.beta !== null) currentBeta = event.beta;
        }

        // 2. 核心逻辑 (低频 1秒1次，负责计算和更新UI)
        function updateLogic() {
            // LED 闪烁效果
            led.classList.add('blink');
            setTimeout(() => led.classList.remove('blink'), 200);

            // 显示原始数据
            rawG.innerText = currentGamma.toFixed(1);
            rawB.innerText = currentBeta.toFixed(1);

            // --- X轴计算 (左右倾斜) ---
            // Gamma: -30(左) 到 30(右) -> 0 到 500
            let x = mapRange(currentGamma, -MAX_TILT, MAX_TILT, 0, 500);

            // --- Y轴计算 (前后倾斜) ---
            let y;
            if (INVERT_Y) {
                // 符合直觉模式：手机头抬起(Beta>0) -> Y变小(向上)
                // Beta: -30(低头) 到 30(抬头) -> 500 到 0
                y = mapRange(currentBeta, -MAX_TILT, MAX_TILT, 500, 0);
            } else {
                // 物理滚动模式：手机头抬起(Beta>0) -> Y变大(向下)
                y = mapRange(currentBeta, -MAX_TILT, MAX_TILT, 0, 500);
            }

            // 限制范围
            x = clamp(Math.round(x), 0, 500);
            y = clamp(Math.round(y), 0, 500);

            // 更新数值显示
            valX.innerText = x;
            valY.innerText = y;

            // 更新小球位置 (转换为百分比以适应不同屏幕宽度的框)
            // 0 -> 0%, 500 -> 100%
            ball.style.left = (x / 500 * 100) + '%';
            ball.style.top = (y / 500 * 100) + '%';
        }

        // 权限处理 (iOS)
        const btn = document.getElementById('permission-btn');
        function requestPermission() {
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(state => {
                        if (state === 'granted') {
                            window.addEventListener('deviceorientation', handleOrientation);
                            startTimer();
                            btn.style.display = 'none';
                        } else {
                            alert('无权限');
                        }
                    })
                    .catch(console.error);
            } else {
                window.addEventListener('deviceorientation', handleOrientation);
                startTimer();
            }
        }

        function startTimer() {
            statusText.innerText = "数据同步中 (1秒/次)";
            statusText.style.color = "#00ff00";
            // 启动定时器，每1000ms执行一次 updateLogic
            if(timer) clearInterval(timer);
            timer = setInterval(updateLogic, UPDATE_INTERVAL);
        }

        // 初始化
        if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
            btn.style.display = 'block';
            btn.addEventListener('click', requestPermission);
        } else {
            window.addEventListener('deviceorientation', handleOrientation);
            startTimer();
        }
    </script>
</body>
</html>